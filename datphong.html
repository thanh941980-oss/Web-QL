<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt phòng - Quản lý nhà trọ</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
        font-size: 14px;
    }
    
    header {
        background-color: #2c3e50;
        color: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-top: 20px;
    }
    
    .form-group {
        margin-bottom: 0.7rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.3rem;
        font-weight: 500;
    }
    
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 0.7rem;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .btn {
        display: inline-block;
        padding: 0.6rem 1.2rem;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .btn:hover {
        background-color: #2980b9;
    }
    
    .back-btn {
        background-color: #7f8c8d;
    }
    
    .back-btn:hover {
        background-color: #95a5a6;
    }
    
    .logout-btn {
        background-color: #e74c3c;
    }
    
    .logout-btn:hover {
        background-color: #c0392b;
    }
    
    @media (max-width: 768px) {
        header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    
        .form-row {
            flex-direction: column;
            gap: 10px;
        }
    
        .btn {
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
    
        .container {
            padding: 10px;
        }
    
        h2 {
            font-size: 1.2rem;
            text-align: center;
        }
    }
</style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <header>
        <h1>Quản lý nhà trọ - Đặt phòng</h1>
        <div>
            <button onclick="window.location.href='dashboard.html'" class="btn back-btn">Quay lại</button>
            <button id="logoutBtn" class="btn logout-btn">Đăng xuất</button>
        </div>
    </header>

    <div class="container">
        <h2>Thông tin đặt phòng</h2>
        
        <div class="form-container">
            <div class="form-row">
                <div class="form-group">
                    <label for="roomSelect">Chọn phòng</label>
                    <select id="roomSelect">
                        <option value="">-- Chọn phòng --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="customerName">Người đặt phòng</label>
                    <input type="text" id="customerName" placeholder="Họ tên người đặt">
                </div>
            </div>
            
            <div class="form-group">
                <label for="sharedCustomers">Người ở chung (nếu có, cách nhau bằng dấu phẩy)</label>
                <input type="text" id="sharedCustomers" placeholder="Người ở chung">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="idNumber">Số CCCD/CMND</label>
                    <input type="text" id="idNumber" placeholder="Số CCCD/CMND">
                </div>
                
                <div class="form-group">
                    <label for="roomPrice">Tiền phòng (VNĐ/tháng)</label>
                    <input type="number" id="roomPrice" placeholder="Tiền phòng">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="initialElectricity">Chỉ số điện lúc đặt phòng</label>
                    <input type="number" id="initialElectricity" placeholder="Chỉ số điện">
                </div>
                
                <div class="form-group">
                    <label for="initialWater">Chỉ số nước lúc đặt phòng</label>
                    <input type="number" id="initialWater" placeholder="Chỉ số nước">
                </div>
            </div>
            
            <div class="form-group">
                <label for="notes">Ghi chú</label>
                <textarea id="notes" rows="3" placeholder="Ghi chú"></textarea>
            </div>
            
            <button id="saveBtn" class="btn">Lưu thông tin</button>
        </div>
    </div>

    <script>
        // Cấu hình Firebase
        const firebaseConfig = { 
            apiKey: "AIzaSyAz38ll5L6nZOicZyQRFtKd0TuzohrLFws",
            authDomain: "quan-ly-nha-tro-2a4bf.firebaseapp.com",
            databaseURL: "https://quan-ly-nha-tro-2a4bf-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quan-ly-nha-tro-2a4bf",
            storageBucket: "quan-ly-nha-tro-2a4bf.firebasestorage.app",
            messagingSenderId: "490747665921",
            appId: "1:490747665921:web:48b0e2bad3a0f894c22a00"
        };
        
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Biến lưu thông tin user hiện tại
        let currentUser = null;
        
        // Kiểm tra trạng thái đăng nhập
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                console.log('User ID:', user.uid);
                loadAvailableRooms();
                loadLicenseStatus();
            }
        });
        
        // Tải danh sách phòng trống theo user ID - FIXED
        function loadAvailableRooms() {
            const roomRef = database.ref(`users/${currentUser.uid}/rooms`);
            
            roomRef.once('value')
                .then((snapshot) => {
                    const roomSelect = document.getElementById('roomSelect');
                    roomSelect.innerHTML = '<option value="">-- Chọn phòng --</option>';

                    console.log('Rooms snapshot:', snapshot.val());
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const room = childSnapshot.val();
                            const roomNumber = childSnapshot.key; // Số phòng là key
                            
                            console.log('Room found:', roomNumber, room);
                            
                            // Chỉ hiển thị phòng có status là 'available'
                            if (room.status === 'available') {
                                const option = document.createElement('option');
                                option.value = roomNumber;
                                option.textContent = `Phòng ${roomNumber} - ${room.price ? room.price.toLocaleString('vi-VN') : '0'} VNĐ`;
                                option.setAttribute("data-price", room.price || 0);
                                roomSelect.appendChild(option);
                            }
                        });
                        
                        // Nếu không có phòng trống nào
                        if (roomSelect.options.length === 1) {
                            const option = document.createElement('option');
                            option.textContent = 'Không có phòng trống';
                            option.disabled = true;
                            roomSelect.appendChild(option);
                        }
                    } else {
                        const option = document.createElement('option');
                        option.textContent = 'Không có phòng nào';
                        option.disabled = true;
                        roomSelect.appendChild(option);
                    }
                })
                .catch((error) => {
                    console.error('Lỗi khi tải phòng:', error);
                    const roomSelect = document.getElementById('roomSelect');
                    roomSelect.innerHTML = '<option value="">-- Lỗi tải phòng --</option>';
                });

            // Khi chọn phòng thì tự điền giá vào ô "Tiền phòng"
            document.getElementById('roomSelect').addEventListener('change', function () {
                const selectedOption = this.options[this.selectedIndex];
                const price = selectedOption.getAttribute("data-price");
                if (price && price !== "0") {
                    document.getElementById('roomPrice').value = price;
                } else {
                    document.getElementById('roomPrice').value = "";
                }
            });
        }
        
        // Xử lý lưu thông tin đặt phòng - FIXED
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const roomId = document.getElementById('roomSelect').value;
            const customerName = document.getElementById('customerName').value;
            const idNumber = document.getElementById('idNumber').value;
            const roomPrice = document.getElementById('roomPrice').value;
            const initialElectricity = document.getElementById('initialElectricity').value;
            const initialWater = document.getElementById('initialWater').value;
            const notes = document.getElementById('notes').value;
            const sharedCustomers = document.getElementById('sharedCustomers').value.split(',').map(item => item.trim());
            
            if (!roomId || !customerName || !idNumber || !roomPrice || !initialElectricity || !initialWater) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const bookingData = {
                roomId: roomId,
                customerName: customerName,
                idNumber: idNumber,
                roomPrice: parseInt(roomPrice),
                initialElectricity: parseInt(initialElectricity),
                initialWater: parseInt(initialWater),
                sharedCustomers: sharedCustomers,
                notes: notes,
                bookingDate: new Date().toISOString(),
                status: 'occupied'
            };
            
            try {
                // Cập nhật trạng thái phòng theo user ID
                await database.ref(`users/${currentUser.uid}/rooms/${roomId}`).update({
                    status: 'occupied'
                });
                
                // Lưu thông tin đặt phòng theo user ID
                await database.ref(`users/${currentUser.uid}/bookings`).push(bookingData);
                
                alert('Đặt phòng thành công!');
                window.location.reload();
            } catch (error) {
                console.error('Lỗi khi đặt phòng:', error);
                alert('Có lỗi xảy ra khi đặt phòng.');
            }
        });
        
        // Xử lý đăng xuất
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.error('Lỗi khi đăng xuất:', error);
                });
        });

        // Load trạng thái bản quyền
        function loadLicenseStatus(){
            database.ref(`users/${currentUser.uid}/license`).on('value',snap=>{
                if(snap.exists()&&snap.val().licensed){
                    document.getElementById('licenseStatus').textContent='Đã cấp bản quyền';
                }else{
                    document.getElementById('licenseStatus').textContent='Miễn phí';
                }
            });
        }
    </script>

<footer style="text-align:center; padding:10px; font-size:0.9rem;">
  © <span id="copyrightYear"></span> Quản lý nhà trọ — Bản quyền <strong id="licenseStatus">Miễn phí</strong>
  <div style="font-size:0.75rem; margin-top:4px; color:#666;">
    Nếu đã kích hoạt bản quyền, hệ thống sẽ lưu không giới hạn số phòng.
  </div>
</footer>
<script>
  document.getElementById('copyrightYear').textContent = new Date().getFullYear();
</script>

</body>
</html>
